{% extends "base.html" %}
{% block title %}FirePi – Administration{% endblock %}
{% block content %}
<div id="calibError" class="alert alert-danger d-none" role="alert">
  <i class="bi bi-exclamation-triangle me-1"></i> Could not load snapshot/ROIs.
</div>
<div class="row g-4">
  <div class="col-12 col-xl-8">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <div class="section-title">Camera Snapshot</div>
          <small class="text-muted">Draw rectangles directly on the image.</small>
        </div>
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted">Image: <span id="snapMeta">—</span></small>
          <button id="btnSnapshot" class="btn btn-outline-light btn-sm" type="button" title="Grab new snapshot"><i class="bi bi-camera me-1"></i>Snapshot</button>
          <button id="btnSaveRois" class="btn btn-primary btn-sm" type="button" title="Save ROI YAML"><i class="bi bi-save me-1"></i>Save ROIs</button>
          <button id="btnReloadWorker" class="btn btn-outline-light btn-sm" type="button" title="Reload ROI config in background worker"><i class="bi bi-arrow-repeat me-1"></i>Reload</button>
          <button class="btn btn-outline-light btn-sm" id="btnSnapshot">
            <i class="bi bi-camera me-1"></i>Snapshot
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="calib-stage rounded-3">
          <img id="snapImg" alt="Snapshot">
          <canvas id="calibCanvas"></canvas>
        </div>
        <div class="text-muted small mt-2">Current rect: <span id="curRect">—</span></div>
      </div>
    </div>
  </div>
  <div class="col-12 col-xl-4">
    <div class="card shadow-sm">
      <div class="card-header">
        <div class="section-title">Controls</div>
        <small class="text-muted">Pick a target, then drag on the image.</small>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Target ROI</label>
          <select id="roiTarget" class="form-select">
            <optgroup label="LCDs">
              <option value="lcd:lcd1">LCD 1</option>
              <option value="lcd:lcd2">LCD 2</option>
              <option value="lcd:lcd3">LCD 3</option>
              <option value="lcd:lcd4">LCD 4</option>
            </optgroup>
            <optgroup label="LEDs">
              <option value="led:opr_ctrl">OPR CTRL</option>
              <option value="led:interlck">INTRLCK</option>
              <option value="led:ptfi">PTFI</option>
              <option value="led:flame">FLAME</option>
              <option value="led:alarm">ALARM</option>
            </optgroup>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">7-Seg Threshold (<span id="segThrVal">0.55</span>)</label>
          <input id="segThr" type="range" class="form-range" min="0.30" max="0.80" step="0.01" value="0.55">
        </div>
        <div class="mb-3">
          <label class="form-label">Digits per LCD</label>
          <input id="digitCount" type="number" class="form-control" min="1" max="6" value="4">
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="lcdInverted">
          <label class="form-check-label" for="lcdInverted">LCD is inverted (lit segments are darker)</label>
        </div>
        <div class="mb-3">
          <label class="form-label">LED Sat/Val thresholds</label>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label small">Saturation</label>
              <input id="ledSat" type="range" class="form-range" min="50" max="200" step="1">
            </div>
            <div class="col-6">
              <label class="form-label small">Value</label>
              <input id="ledVal" type="range" class="form-range" min="50" max="200" step="1">
            </div>
          </div>
        </div>
        <div class="alert alert-secondary small">
          Click <strong>Snapshot</strong>, choose a <strong>Target ROI</strong>, draw the rectangle, then <strong>Save ROIs</strong>.
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <div class="section-title">Dry-Run Result (Uploaded Photo)</div>
          <small class="text-muted">Decoded values using current ROIs & thresholds.</small>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-12 col-lg-6">
            <div class="mb-3">
              <div class="fw-semibold mb-2">Digital Displays</div>
              <div id="testLcd1" class="sevenseg-group"></div>
              <div id="testLcd2" class="sevenseg-group mt-2"></div>
              <div id="testLcd3" class="sevenseg-group mt-2"></div>
              <div id="testLcd4" class="sevenseg-group mt-2"></div>
            </div>
            <div>
              <div class="fw-semibold mb-2">Status LEDs</div>
              <ul class="list-group list-group-flush led-stack">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                  <span class="fw-semibold">OPR CTRL</span><span class="led-dot" id="test-led-opr_ctrl"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                  <span class="fw-semibold">INTRLCK</span><span class="led-dot" id="test-led-interlck"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                  <span class="fw-semibold">PTFI</span><span class="led-dot" id="test-led-ptfi"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                  <span class="fw-semibold">FLAME</span><span class="led-dot" id="test-led-flame"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                  <span class="fw-semibold">ALARM</span><span class="led-dot" id="test-led-alarm"></span>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="fw-semibold mb-2">Annotated Preview</div>
            <img id="testPreview" class="img-fluid rounded-3 border border-secondary" alt="Annotated preview">
            <small class="text-muted d-block mt-2">Boxes are drawn at current ROIs (green=ON, red=OFF for LEDs).</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/panel_calibrate.js') }}"></script>
{% endblock %}