#!/usr/bin/env bash
set -euo pipefail

APP_DIR="$(pwd)"
SERVICE_NAME="firepi"
OVERLAY="hifiberry-dac"
CARD_ID=""
PYTHON_BIN="/usr/bin/python3"

print_usage() {
  cat <<EOF
Usage: sudo bash $0 [--app-dir PATH] [--service-name NAME] [--overlay NAME] [--card-id ALSA_ID]

Options:
  --app-dir PATH        Path to your app directory (contains app.py). Default: current directory
  --service-name NAME   Systemd unit name (NAME.service). Default: firepi
  --overlay NAME        I2S overlay to enable. Default: hifiberry-dac
  --card-id ALSA_ID     ALSA card ID for default output (e.g., sndrpihifiberry). Default: auto-detect (fallback -> sndrpihifiberry)
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --app-dir)       APP_DIR="$2"; shift 2 ;;
    --service-name)  SERVICE_NAME="$2"; shift 2 ;;
    --overlay)       OVERLAY="$2"; shift 2 ;;
    --card-id)       CARD_ID="$2"; shift 2 ;;
    -h|--help)       print_usage; exit 0 ;;
    *) echo "Unknown arg: $1"; print_usage; exit 1 ;;
  esac
done

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "Please run as root (use sudo)." >&2
  exit 1
fi

if [[ ! -d "$APP_DIR" ]]; then
  echo "App directory not found: $APP_DIR" >&2
  exit 1
fi
if [[ ! -f "$APP_DIR/app.py" ]]; then
  echo "app.py not found in $APP_DIR" >&2
  exit 1
fi
if [[ -f "$APP_DIR/requirements.txt" ]]; then
  echo "Requirements.txt missing in $APP_DIR" >&2
  exit 1
fi
for f in firepi-softap.sh firepi-wifi-online.sh firepi-wifi-switch.sh; do
  if [[ ! -f "${APP_DIR}/wifi_scripts/${f}" ]]; then
    echo "[firepi] ERROR: Missing ${APP_DIR}/wifi_scripts/${f}."
    exit 2
  fi
  chmod 0755 "${APP_DIR}/wifi_scripts/${f}"
done

RUN_USER="${SUDO_USER:-$USER}"
RUN_GROUP="$(id -gn "$RUN_USER")"

run_as_user() {
  sudo -u "$RUN_USER" -H bash -lc "$*"
}

echo "==> Using:"
echo "    APP_DIR        = $APP_DIR"
echo "    SERVICE_NAME   = $SERVICE_NAME"
echo "    OVERLAY        = $OVERLAY"
echo "    CARD_ID (in)   = ${CARD_ID:-<auto>}"
echo "    RUN_USER/GROUP = $RUN_USER:$RUN_GROUP"
echo

echo "==> Installing OS packages..."
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y \
  python3 python3-venv python3-pip git alsa-utils mpg123 sox libsox-fmt-mp3 python3-numpy python3-opencv \
  python3-gpiozero python3-paho-mqtt python3-picamera2 libcamera-apps network-manager avahi-daemon jq || true

echo "==> Disabling pigpiod (if present)..."
if systemctl list-unit-files | grep -q '^pigpiod\.service'; then
  systemctl disable --now pigpiod.service || true
fi

if ! id -nG "$RUN_USER" | tr ' ' '\n' | grep -qx audio; then
  echo "==> Adding $RUN_USER to 'audio' group..."
  usermod -aG audio "$RUN_USER"
fi

if ! id -nG "$RUN_USER" | tr ' ' '\n' | grep -qx video; then
  echo "==> Adding $RUN_USER to 'video' group..."
  usermod -aG video "$RUN_USER"
fi

echo "${RUN_USER} ALL=NOPASSWD: /sbin/reboot, /usr/sbin/reboot, /usr/bin/reboot" | sudo tee /etc/sudoers.d/firepi-reboot >/dev/null
sudo chmod 440 /etc/sudoers.d/firepi-reboot

CONFIG_TXT=""
for f in /boot/firmware/config.txt /boot/config.txt; do
  if [[ -f "$f" ]]; then CONFIG_TXT="$f"; break; fi
done
if [[ -z "$CONFIG_TXT" ]]; then
  CONFIG_TXT="/boot/firmware/config.txt"
  touch "$CONFIG_TXT"
fi

echo "==> Updating $CONFIG_TXT (disable onboard audio, add overlay)..."
cp -a "$CONFIG_TXT" "$CONFIG_TXT.bak.$(date +%Y%m%d-%H%M%S)"

if grep -Eq '^\s*dtparam=audio=' "$CONFIG_TXT"; then
  sed -i 's/^\s*dtparam=audio=.*/dtparam=audio=off/g' "$CONFIG_TXT"
else
  echo "dtparam=audio=off" >> "$CONFIG_TXT"
fi

sed -i "/^dtoverlay=${OVERLAY//\//\\/}/d" "$CONFIG_TXT"
echo "dtoverlay=${OVERLAY}" >> "$CONFIG_TXT"

detect_card_id() {
  local id=""
  if aplay -l >/tmp/aplay_list 2>/dev/null; then
    id="$(awk -F'[:, ]+' '/^card [0-9]+:/ {print $3; exit}' /tmp/aplay_list)"
  fi
  echo "$id"
}

if [[ -z "$CARD_ID" ]]; then
  CARD_ID="$(detect_card_id || true)"
fi
if [[ -z "$CARD_ID" ]]; then
  CARD_ID="sndrpihifiberry"
fi
echo "==> ALSA CARD_ID (out) = $CARD_ID"

ASOUND="/etc/asound.conf"
echo "==> Writing $ASOUND ..."
cp -a "$ASOUND" "$ASOUND.bak.$(date +%Y%m%d-%H%M%S)" 2>/dev/null || true

cat >"$ASOUND" <<'EOF'
# Auto-generated by FirePi setup

# Hardware: HiFiBerry DAC (card 0, device 0)
pcm.i2s_hw {
  type hw
  card 0
  device 0
}

# Mono -> both channels (duplicate L to L/R)
pcm.route_out {
  type route
  slave.pcm "i2s_hw"
  slave.channels 2
  ttable.0.0 1   # L -> L
  ttable.0.1 1   # L -> R
}

# Software volume control "PCM" in default path
pcm.!default {
  type softvol
  slave.pcm "route_out"
  control { name "PCM"; card 0 }
  min_dB -51.0
  max_dB 0.0
}

ctl.!default {
  type hw
  card 0
}
EOF

echo "==> Creating/refreshing Python venv with system site packages in ${APP_DIR}/.venv ..."
chown -R "$RUN_USER:$RUN_GROUP" "$APP_DIR"

LOG_DIR="/var/log/firepi"
mkdir -p "$LOG_DIR"
chown -R "$RUN_USER:$RUN_GROUP" "$LOG_DIR"

VENV_DIR="${APP_DIR}/.venv"
VENV_PY="${VENV_DIR}/bin/python"
VENV_PIP="${VENV_DIR}/bin/pip"

if [[ -d "$VENV_DIR" ]]; then
  rm -rf "$VENV_DIR"
fi
run_as_user "$PYTHON_BIN -m venv --system-site-packages '$VENV_DIR'"
run_as_user "'$VENV_PY' -m pip install --upgrade pip setuptools wheel"
run_as_user "'$VENV_PIP' install -r '$APP_DIR/requirements.txt'"

echo "[firepi] Writing system units..."
SERVICE_UNIT="/etc/systemd/system/firepi.service"
SOFTAP_UNIT="/etc/systemd/system/firepi-softap@.service"
WIFI_ONLINE_UNIT="/etc/systemd/system/firepi-wifi-online.service"
WIFI_SWITCH_UNIT="/etc/systemd/system/firepi-wifi-switch.service"
WIFI_SWITCH_PATH="/etc/systemd/system/firepi-wifi-switch.path"

sudo bash -c "cat > '${SERVICE_UNIT}'" <<'EOF_SERVICE_UNIT'
[Unit]
Description=FirePi Monitor
After=network-online.target sound.target
Wants=network-online.target

[Service]
Type=simple
User=@RUN_USER@
Group=@RUN_GROUP@
WorkingDirectory=@APP_HOME@
Environment=PYTHONUNBUFFERED=1
Environment=FIREPI_LOG_DIR=/var/log/firepi
Environment=FIREPI_LOG_LEVEL=INFO
Environment=FIREPI_UPLOAD_URL="http://a129784626.asuscomm.com:8888/upload"
Environment=FIREPI_UPLOAD_TOKEN="sYfh48fkS3920AFHGDSB38SDdfhDfhei4"
ExecStart=@APP_HOME@/.venv/bin/python app.py
Restart=always
RestartSec=3
KillMode=control-group
TimeoutStopSec=10

[Install]
WantedBy=multi-user.target
EOF_SERVICE_UNIT

sudo bash -c "cat > '${SOFTAP_UNIT}'" <<'EOF_SOFTAP_UNIT'
[Unit]
Description=FirePi SoftAP provision for %i minutes (only if STA not connected)
After=NetworkManager.service NetworkManager-wait-online.service
Wants=NetworkManager-wait-online.service

# Skip service entirely if Wi-Fi is already connected
ExecCondition=/bin/sh -lc 'IF=$(nmcli -t -f DEVICE,TYPE dev status | awk -F: '\''$2=="wifi"{print $1; exit}'\''); [ -n "$IF" ] && nmcli -t -f DEVICE,STATE dev status | grep -q "^$IF:connected" && exit 1 || exit 0'

[Service]
Type=oneshot
# Set APP_HOME to your FirePi app root if not already present in environment
Environment=APP_HOME=@APP_HOME@
ExecStart=/bin/bash -lc '@APP_HOME@/wifi_scripts/firepi-softap.sh %i
User=@RUN_USER@
Group=@RUN_GROUP@

[Install]
WantedBy=multi-user.target
EOF_SOFTAP_UNIT

sudo bash -c "cat > '${WIFI_ONLINE_UNIT}'" <<'EOF_ONLINE_UNIT'
[Unit]
Description=FirePi WiFi bring-up (open AP if not connected)
After=network.target NetworkManager.service
Wants=NetworkManager.service

[Service]
Type=oneshot
Environment=APP_HOME=@APP_HOME@
WorkingDirectory=@APP_HOME@
ExecStart=@APP_HOME@/wifi_scripts/firepi-wifi-online.sh

[Install]
WantedBy=multi-user.target
EOF_ONLINE_UNIT

sudo bash -c "cat > '${WIFI_SWITCH_UNIT}'" <<'EOF_SWITCH_UNIT'
[Unit]
Description=FirePi WiFi switch (reads pending creds)
After=NetworkManager.service
Wants=NetworkManager.service

[Service]
Type=oneshot
Environment=APP_HOME=@APP_HOME@
Environment=FIREPI_PENDING_WIFI=@APP_HOME@/instance/pending_wifi.json
WorkingDirectory=@APP_HOME@
ExecStart=@APP_HOME@/wifi_scripts/firepi-wifi-switch.sh
EOF_SWITCH_UNIT

sudo bash -c "cat > '${WIFI_SWITCH_PATH}'" <<'EOF_PATH'
[Unit]
Description=Watch pending WiFi credentials and trigger switch

[Path]
PathChanged=@APP_HOME@/instance/pending_wifi.json
PathModified=@APP_HOME@/instance/pending_wifi.json

[Install]
WantedBy=multi-user.target
EOF_PATH

# Replace @APP_HOME@ placeholders with actual path
sudo sed -i "s|@APP_HOME@|${APP_DIR}|g" "${SERVICE_UNIT}" "${SOFTAP_UNIT}" "${WIFI_ONLINE_UNIT}" "${WIFI_SWITCH_UNIT}" "${WIFI_SWITCH_PATH}"
sudo sed -i "s|@RUN_USER@|${RUN_USER}|g" "${SERVICE_UNIT}" "${SOFTAP_UNIT}" "${WIFI_ONLINE_UNIT}" "${WIFI_SWITCH_UNIT}" "${WIFI_SWITCH_PATH}"
sudo sed -i "s|@RUN_GROUP@|${RUN_GROUP}|g" "${SERVICE_UNIT}" "${SOFTAP_UNIT}" "${WIFI_ONLINE_UNIT}" "${WIFI_SWITCH_UNIT}" "${WIFI_SWITCH_PATH}"

echo "[firepi] Enabling services..."
systemctl daemon-reload
systemctl enable --now NetworkManager.service
systemctl enable --now avahi-daemon.service || true
systemctl enable firepi-wifi-online.service
systemctl enable --now firepi-wifi-switch.path
systemctl enable "${SERVICE_NAME}.service"

#compute and print SSID/PSK now, and save to a file
IFACE=$(nmcli -t -f DEVICE,TYPE dev status | awk -F: '$2=="wifi"{print $1; exit}'); [[ -z "$IFACE" ]] && IFACE=wlan0
SER=$(awk -F': ' '/Serial/ { print $2 }' /proc/cpuinfo)
SER_SUFFIX="${SER: -4}"; [[ -z "$SER_SUFFIX" ]] && SER_SUFFIX="0000"
MAC=$(cat "/sys/class/net/${IFACE}/address" 2>/dev/null | tr -d ':' | tr '[:lower:]' '[:upper:]')
if [[ -n "$MAC" ]]; then MAC_SUFFIX="${MAC: -6}"; else TMP="${SER: -6}"; MAC_SUFFIX="$(printf '%06s' "$TMP" | tr ' ' '0' | tr '[:lower:]' '[:upper:]')"; fi
if [[ ${#MAC_SUFFIX} -lt 6 ]]; then MAC_SUFFIX="$(printf '%06s' "$MAC_SUFFIX" | tr ' ' '0')"; fi
AP_SSID="FirePi-${SER_SUFFIX}-${MAC_SUFFIX}"
AP_PSK="FirePi${MAC_SUFFIX}"
INFO_FILE="${APP_DIR}/instance/onboarding_info.txt"
printf 'SSID: %s\nPSK : %s\n' "$AP_SSID" "$AP_PSK" | tee "$INFO_FILE"

# --- Ensure instance dir ---
mkdir -p "${APP_DIR}/instance"
chmod 0755 "${APP_DIR}/instance"

HOST_NAME="$(hostname -f 2>/dev/null || hostname)"
if [[ "$HOST_NAME" != *.* ]]; then
  HOST_NAME="${HOST_NAME}.local"
fi
HOST_IP="$(hostname -I 2>/dev/null | awk '{print $1}')"
SELF_URL_HOST="http://${HOST_NAME}:5000/"
SELF_URL_IP="http://${HOST_IP}:5000/"

echo
echo "================"
echo "SETUP COMPLETE"
echo "================"
echo
echo "Next steps:"
echo "  1) Reboot now:"
echo "       sudo reboot"
echo
echo "  2) Open the app:"
echo "       ${SELF_URL_HOST}"
echo "       ${SELF_URL_IP}"
echo
echo "On-board AP:"
echo "   SSID: ${AP_SSID}"
echo "   PSK:  ${AP_PSK}"
echo
